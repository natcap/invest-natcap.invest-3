"""URI level tests for the aquaculture core module"""

import os, sys
import unittest
import ogr
import logging
import re
import filecmp

from invest_natcap.finfish_aquaculture import finfish_aquaculture_core
import invest_test_core

LOGGER = logging.getLogger('finfish_aquaculture_test')
logging.basicConfig(format='%(asctime)s %(name)-15s %(levelname)-8s \
    %(message)s', level=logging.DEBUG, datefmt='%m/%d/%Y %H:%M:%S ')

class TestFinfishAquacultureCore(unittest.TestCase):
   
    
    def setUp(self):
    
        ff_farm_loc = './invest-data/test/data/aquaculture_data/Test_Data/Finfish_Netpens_Reg_Test.shp'
        ff_aqua_args = {}
        
        #Biophysical
        ff_aqua_args['workspace_dir'] = './invest-data/test/data/test_out/Aquaculture/Re_Testing'
        ff_aqua_args['farm_ID'] = 'FarmID'
        ff_aqua_args['ff_farm_file'] = ogr.Open(ff_farm_loc)
        ff_aqua_args['g_param_a'] = 0.038
        ff_aqua_args['g_param_b'] = 2
        ff_aqua_args['water_temp_tbl'] = {'344': {'1': '7', '4': '8'}, '0': {'1': '7', '4': '8'}, 
                                          '346': {'1': '7', '4': '8'}, '347': {'1': '7', '4': '8'}, 
                                          '340': {'1': '7', '4': '8'}, '341': {'1': '7', '4': '8'}, 
                                          '342': {'1': '7', '4': '8'}, '343': {'1': '7', '4': '8'}, 
                                          '348': {'1': '7', '4': '8'}, '349': {'1': '7', '4': '8'}, 
                                          '298': {'1': '7', '4': '8'}, '299': {'1': '7', '4': '8'}, 
                                          '296': {'1': '7', '4': '8'}, '297': {'1': '7', '4': '8'}, '294': {'1': '7', '4': '8'}, '295': {'1': '7', '4': '8'}, '292': {'1': '7', '4': '8'}, '293': {'1': '7', '4': '8'}, '290': {'1': '7', '4': '8'}, '291': {'1': '7', '4': '8'}, '199': {'1': '7', '4': '8'}, 
                                          '198': {'1': '7', '4': '8'}, '195': {'1': '7', '4': '8'}, '194': {'1': '7', '4': '8'}, '197': {'1': '7', '4': '8'}, '196': {'1': '7', '4': '8'}, '191': {'1': '7', '4': '8'}, '190': {'1': '7', '4': '8'}, '193': {'1': '7', '4': '8'}, '192': {'1': '7', '4': '8'}, 
                                          '270': {'1': '7', '4': '8'}, '271': {'1': '7', '4': '8'}, '272': {'1': '7', '4': '8'}, '273': {'1': '7', '4': '8'}, '274': {'1': '7', '4': '8'}, '275': {'1': '7', '4': '8'}, '276': {'1': '7', '4': '8'}, '277': {'1': '7', '4': '8'}, '278': {'1': '7', '4': '8'}, 
                                          '279': {'1': '7', '4': '8'}, '108': {'1': '7', '4': '8'}, '109': {'1': '7', '4': '8'}, '102': {'1': '7', '4': '8'}, '103': {'1': '7', '4': '8'}, '100': {'1': '7', '4': '8'}, '101': {'1': '7', '4': '8'}, '106': {'1': '7', '4': '8'}, '107': {'1': '7', '4': '8'}, 
                                          '104': {'1': '7', '4': '8'}, '105': {'1': '7', '4': '8'}, '39': {'1': '7', '4': '8'}, '38': {'1': '7', '4': '8'}, '33': {'1': '7', '4': '8'}, '32': {'1': '7', '4': '8'}, '31': {'1': '7', '4': '8'}, '30': {'1': '7', '4': '8'}, '37': {'1': '7', '4': '8'}, 
                                          '36': {'1': '7', '4': '8'}, '35': {'1': '7', '4': '8'}, '34': {'1': '7', '4': '8'}, '339': {'1': '7', '4': '8'}, '338': {'1': '7', '4': '8'}, '335': {'1': '7', '4': '8'}, '334': {'1': '7', '4': '8'}, '337': {'1': '7', '4': '8'}, '336': {'1': '7', '4': '8'}, 
                                          '331': {'1': '7', '4': '8'}, '330': {'1': '7', '4': '8'}, '333': {'1': '7', '4': '8'}, '332': {'1': '7', '4': '8'}, '345': {'1': '7', '4': '8'}, '6': {'1': '7', '4': '8'}, '99': {'1': '7', '4': '8'}, '98': {'1': '7', '4': '8'}, '91': {'1': '7', '4': '8'}, 
                                          '90': {'1': '7', '4': '8'}, '93': {'1': '7', '4': '8'}, '92': {'1': '7', '4': '8'}, '95': {'1': '7', '4': '8'}, '94': {'1': '7', '4': '8'}, '97': {'1': '7', '4': '8'}, '96': {'1': '7', '4': '8'}, '238': {'1': '7', '4': '8'}, '239': {'1': '7', '4': '8'}, '234': {'1': '7', '4': '8'}, 
                                          '235': {'1': '7', '4': '8'}, '236': {'1': '7', '4': '8'}, '237': {'1': '7', '4': '8'}, '230': {'1': '7', '4': '8'}, '231': {'1': '7', '4': '8'}, '232': {'1': '7', '4': '8'}, '233': {'1': '7', '4': '8'}, '1': {'1': '7', '4': '8'}, '146': {'1': '7', '4': '8'}, '147': {'1': '7', '4': '8'}, 
                                          '144': {'1': '7', '4': '8'}, '145': {'1': '7', '4': '8'}, '142': {'1': '7', '4': '8'}, '143': {'1': '7', '4': '8'}, '140': {'1': '7', '4': '8'}, '141': {'1': '7', '4': '8'}, '148': {'1': '7', '4': '8'}, '149': {'1': '7', '4': '8'}, '133': {'1': '7', '4': '8'}, 
                                          '132': {'1': '7', '4': '8'}, '131': {'1': '7', '4': '8'}, '130': {'1': '7', '4': '8'}, '137': {'1': '7', '4': '8'}, '136': {'1': '7', '4': '8'}, '135': {'1': '7', '4': '8'}, '134': {'1': '7', '4': '8'}, '139': {'1': '7', '4': '8'}, '138': {'1': '7', '4': '8'}, '24': {'1': '7', '4': '8'}, 
                                          '25': {'1': '7', '4': '8'}, '26': {'1': '7', '4': '8'}, '27': {'1': '7', '4': '8'}, '20': {'1': '7', '4': '8'}, '21': {'1': '7', '4': '8'}, '22': {'1': '7', '4': '8'}, '23': {'1': '7', '4': '8'}, '28': {'1': '7', '4': '8'}, '29': {'1': '7', '4': '8'}, '88': {'1': '7', '4': '8'}, '89': {'1': '7', '4': '8'}, 
                                          '82': {'1': '7', '4': '8'}, '83': {'1': '7', '4': '8'}, '80': {'1': '7', '4': '8'}, '81': {'1': '7', '4': '8'}, '86': {'1': '7', '4': '8'}, '87': {'1': '7', '4': '8'}, '84': {'1': '7', '4': '8'}, '85': {'1': '7', '4': '8'}, '7': {'1': '7', '4': '8'}, '245': {'1': '7', '4': '8'}, '244': {'1': '7', '4': '8'}, '247': {'1': '7', '4': '8'}, 
                                          '246': {'1': '7', '4': '8'}, '241': {'1': '7', '4': '8'}, '240': {'1': '7', '4': '8'}, '243': {'1': '7', '4': '8'}, '242': {'1': '7', '4': '8'}, '249': {'1': '7', '4': '8'}, '248': {'1': '7', '4': '8'}, '179': {'1': '7', '4': '8'}, '178': {'1': '7', '4': '8'}, '177': {'1': '7', '4': '8'}, '176': {'1': '7', '4': '8'}, '175': {'1': '7', '4': '8'}, 
                                          '174': {'1': '7', '4': '8'}, '173': {'1': '7', '4': '8'}, '172': {'1': '7', '4': '8'}, '171': {'1': '7', '4': '8'}, '170': {'1': '7', '4': '8'}, '253': {'1': '7', '4': '8'}, '182': {'1': '7', '4': '8'}, '183': {'1': '7', '4': '8'}, '180': {'1': '7', '4': '8'}, '181': {'1': '7', '4': '8'}, 
                                          '186': {'1': '7', '4': '8'}, '187': {'1': '7', '4': '8'}, '184': {'1': '7', '4': '8'}, '185': {'1': '7', '4': '8'}, '188': {'1': '7', '4': '8'}, '189': {'1': '7', '4': '8'}, '11': {'1': '7', '4': '8'}, '10': {'1': '7', '4': '8'}, '13': {'1': '7', '4': '8'}, '12': {'1': '7', '4': '8'}, '15': {'1': '7', '4': '8'}, 
                                          '14': {'1': '7', '4': '8'}, '17': {'1': '7', '4': '8'}, '16': {'1': '7', '4': '8'}, '19': {'1': '7', '4': '8'}, '18': {'1': '7', '4': '8'}, '62': {'1': '7', '4': '8'}, '322': {'1': '7', '4': '8'}, '323': {'1': '7', '4': '8'}, '320': {'1': '7', '4': '8'}, '321': {'1': '7', '4': '8'}, '326': {'1': '7', '4': '8'}, '327': {'1': '7', '4': '8'}, 
                                          '324': {'1': '7', '4': '8'}, '325': {'1': '7', '4': '8'}, '328': {'1': '7', '4': '8'}, '329': {'1': '7', '4': '8'}, '201': {'1': '7', '4': '8'}, '200': {'1': '7', '4': '8'}, '203': {'1': '7', '4': '8'}, '202': {'1': '7', '4': '8'}, '205': {'1': '7', '4': '8'}, '204': {'1': '7', '4': '8'}, '207': {'1': '7', '4': '8'}, '206': {'1': '7', '4': '8'}, '209': {'1': '7', '4': '8'}, 
                                          '208': {'1': '7', '4': '8'}, '77': {'1': '7', '4': '8'}, '76': {'1': '7', '4': '8'}, '75': {'1': '7', '4': '8'}, '74': {'1': '7', '4': '8'}, '73': {'1': '7', '4': '8'}, '72': {'1': '7', '4': '8'}, '71': {'1': '7', '4': '8'}, '70': {'1': '7', '4': '8'}, '79': {'1': '7', '4': '8'}, 
                                          '78': {'1': '7', '4': '8'}, '2': {'1': '7', '4': '8'}, '8': {'1': '7', '4': '8'}, '68': {'1': '7', '4': '8'}, '120': {'1': '7', '4': '8'}, '121': {'1': '7', '4': '8'}, '122': {'1': '7', '4': '8'}, '123': {'1': '7', '4': '8'}, '124': {'1': '7', '4': '8'}, '125': {'1': '7', '4': '8'}, '126': {'1': '7', '4': '8'}, 
                                          '127': {'1': '7', '4': '8'}, '128': {'1': '7', '4': '8'}, '129': {'1': '7', '4': '8'}, '319': {'1': '7', '4': '8'}, '318': {'1': '7', '4': '8'}, '313': {'1': '7', '4': '8'}, '312': {'1': '7', '4': '8'}, '311': {'1': '7', '4': '8'}, '310': {'1': '7', '4': '8'}, '317': {'1': '7', '4': '8'}, '316': {'1': '7', '4': '8'}, '315': {'1': '7', '4': '8'}, 
                                          '314': {'1': '7', '4': '8'}, '3': {'1': '7', '4': '8'}, '362': {'1': '7', '4': '8'}, '363': {'1': '7', '4': '8'}, '360': {'1': '7', '4': '8'}, '361': {'1': '7', '4': '8'}, '60': {'1': '7', '4': '8'}, '61': {'1': '7', '4': '8'}, '258': {'1': '7', '4': '8'}, '259': {'1': '7', '4': '8'}, '64': {'1': '7', '4': '8'}, 
                                          '65': {'1': '7', '4': '8'}, '66': {'1': '7', '4': '8'}, '67': {'1': '7', '4': '8'}, '252': {'1': '7', '4': '8'}, '69': {'1': '7', '4': '8'}, '250': {'1': '7', '4': '8'}, '251': {'1': '7', '4': '8'}, '256': {'1': '7', '4': '8'}, '257': {'1': '7', '4': '8'}, '254': {'1': '7', '4': '8'}, '255': {'1': '7', '4': '8'}, '168': {'1': '7', '4': '8'}, 
                                          '169': {'1': '7', '4': '8'}, '164': {'1': '7', '4': '8'}, '165': {'1': '7', '4': '8'}, '166': {'1': '7', '4': '8'}, 
                                          '167': {'1': '7', '4': '8'}, '160': {'1': '7', '4': '8'}, '161': {'1': '7', '4': '8'}, '162': {'1': '7', '4': '8'}, '163': {'1': '7', '4': '8'}, '9': {'1': '7', '4': '8'}, '357': {'1': '7', '4': '8'}, '356': {'1': '7', '4': '8'}, '355': {'1': '7', '4': '8'}, '354': {'1': '7', '4': '8'}, '353': {'1': '7', '4': '8'}, '352': {'1': '7', '4': '8'}, 
                                          '351': {'1': '7', '4': '8'}, '350': {'1': '7', '4': '8'}, '359': {'1': '7', '4': '8'}, '358': {'1': '7', '4': '8'}, '216': {'1': '7', '4': '8'}, '217': {'1': '7', '4': '8'}, '214': {'1': '7', '4': '8'}, '215': {'1': '7', '4': '8'}, '212': {'1': '7', '4': '8'}, '213': {'1': '7', '4': '8'}, '210': {'1': '7', '4': '8'}, '211': {'1': '7', '4': '8'}, 
                                          '218': {'1': '7', '4': '8'}, '219': {'1': '7', '4': '8'}, '289': {'1': '7', '4': '8'}, '288': {'1': '7', '4': '8'}, '4': {'1': '7', '4': '8'}, '281': {'1': '7', '4': '8'}, '280': {'1': '7', '4': '8'}, '283': {'1': '7', '4': '8'}, '282': {'1': '7', '4': '8'}, '285': {'1': '7', '4': '8'}, '284': {'1': '7', '4': '8'}, '287': {'1': '7', '4': '8'}, 
                                          '286': {'1': '7', '4': '8'}, '263': {'1': '7', '4': '8'}, '262': {'1': '7', '4': '8'}, '261': {'1': '7', '4': '8'}, '260': {'1': '7', '4': '8'}, '267': {'1': '7', '4': '8'}, '266': {'1': '7', '4': '8'}, '265': {'1': '7', '4': '8'}, '264': {'1': '7', '4': '8'}, '269': {'1': '7', '4': '8'}, '268': {'1': '7', '4': '8'}, '59': {'1': '7', '4': '8'}, '58': {'1': '7', '4': '8'}, 
                                          '55': {'1': '7', '4': '8'}, '54': {'1': '7', '4': '8'}, '57': {'1': '7', '4': '8'}, '56': {'1': '7', '4': '8'}, '51': {'1': '7', '4': '8'}, '50': {'1': '7', '4': '8'}, '53': {'1': '7', '4': '8'}, '52': {'1': '7', '4': '8'}, '63': {'1': '7', '4': '8'}, '115': {'1': '7', '4': '8'}, '114': {'1': '7', '4': '8'}, '117': {'1': '7', '4': '8'}, 
                                          '116': {'1': '7', '4': '8'}, '111': {'1': '7', '4': '8'}, '110': {'1': '7', '4': '8'}, '113': {'1': '7', '4': '8'}, '112': {'1': '7', '4': '8'}, '119': {'1': '7', '4': '8'}, '118': {'1': '7', '4': '8'}, '308': {'1': '7', '4': '8'}, '309': {'1': '7', '4': '8'}, '300': {'1': '7', '4': '8'}, '301': {'1': '7', '4': '8'}, '302': {'1': '7', '4': '8'}, 
                                          '303': {'1': '7', '4': '8'}, '304': {'1': '7', '4': '8'}, '305': {'1': '7', '4': '8'}, '306': {'1': '7', '4': '8'}, '307': {'1': '7', '4': '8'}, '229': {'1': '7', '4': '8'}, '228': {'1': '7', '4': '8'}, '227': {'1': '7', '4': '8'}, '226': {'1': '7', '4': '8'}, '225': {'1': '7', '4': '8'}, '224': {'1': '7', '4': '8'}, '223': {'1': '7', '4': '8'}, 
                                          '222': {'1': '7', '4': '8'}, '221': {'1': '7', '4': '8'}, '220': {'1': '7', '4': '8'}, '151': {'1': '7', '4': '8'}, '150': {'1': '7', '4': '8'}, '153': {'1': '7', '4': '8'}, '152': {'1': '7', '4': '8'}, '155': {'1': '7', '4': '8'}, '154': {'1': '7', '4': '8'}, '157': {'1': '7', '4': '8'}, '156': {'1': '7', '4': '8'}, '159': {'1': '7', '4': '8'}, '158': {'1': '7', '4': '8'}, 
                                          '48': {'1': '7', '4': '8'}, '49': {'1': '7', '4': '8'}, '46': {'1': '7', '4': '8'}, '47': {'1': '7', '4': '8'}, '44': {'1': '7', '4': '8'}, '45': {'1': '7', '4': '8'}, '42': {'1': '7', '4': '8'}, '43': {'1': '7', '4': '8'}, '40': {'1': '7', '4': '8'}, '41': {'1': '7', '4': '8'}, '5': {'1': '7', '4': '8'}}
        
        ff_aqua_args['farm_op_tbl'] = {'1': {'weight of fish at start (kg)' : '0.06',
                               'target weight of fish at harvest (kg)' : '5.4',
                               'number of fish in farm' : '600000', 
                               'start day for growing' : '1',
                               'Length of Fallowing period' : '30'},
                         '4': {'weight of fish at start (kg)' : '0.08',
                               'target weight of fish at harvest (kg)' : '6',
                               'number of fish in farm' : '500000', 
                               'start day for growing' : '20',
                               'Length of Fallowing period' : '0'}}
        ff_aqua_args['duration'] = 5
        ff_aqua_args['mort_rate_daily'] = 0.000137
        ff_aqua_args['frac_post_process'] = 0.85
        ff_aqua_args['outplant_buffer'] = 3
        
        #Valuation
        ff_aqua_args['do_valuation'] = True
        ff_aqua_args['p_per_kg']= 2.25
        ff_aqua_args['frac_p'] = .3
        ff_aqua_args['discount'] = 0.000192
        
        ff_aqua_args['reg_cy_hist'] = {1: [(1, 3, 6266.532049655182), (363, 365, 6266.532049655182), 
                                           (728, 730, 6266.532049655182), (1093, 1095, 6266.532049655182), 
                                           (1458, 1460, 6266.532049655182), (1823, 1825, 6266.532049655182)], 
                                       4: [(20, 22, 21651.134982624022), (382, 384, 21651.134982624022), 
                                           (386, 388, 21651.134982624022), (747, 749, 21651.134982624022), 
                                           (751, 753, 21651.134982624022), (1112, 1114, 21651.134982624022), 
                                           (1116, 1118, 21651.134982624022), (1477, 1479, 21651.134982624022), 
                                           (1481, 1483, 21651.134982624022)]}
        
        ff_aqua_args['tpw_totals'] = {1: 19170334.68056063, 4: 82792902.94496611}
        ff_aqua_args['indiv_cy_tpw'] = {1: [3195055.7800934385, 3195055.7800934385,
                                             3195055.7800934385, 3195055.7800934385,
                                              3195055.7800934385, 3195055.7800934385], 
                                        4: [9199211.438329568, 9199211.438329568, 
                                            9199211.438329568, 9199211.438329568, 
                                            9199211.438329568, 9199211.438329568, 
                                            9199211.438329568, 9199211.438329568, 
                                            9199211.438329568]}
        #The value history contains a history of tuples that are (net revenue, npv)
        # for that particular cycle.
        ff_aqua_args['reg_value_hist'] =  {1: [(5032212.853647165, 5029315.411732361), 
                                               (5032212.853647165, 4691660.379716688), 
                                               (5032212.853647165, 4374154.623179357), 
                                               (5032212.853647165, 4078135.909026886), 
                                               (5032212.853647165, 3802150.1124727405), 
                                               (5032212.853647165, 3544841.5158939636)], 
                                           4: [(14488758.015369069, 14427692.42493477), 
                                               (14488758.015369069, 13459055.036178194), 
                                               (14488758.015369069, 13448723.441551866), 
                                               (14488758.015369069, 12548220.25580618), 
                                               (14488758.015369069, 12538587.846649937), 
                                               (14488758.015369069, 11699025.761093546), 
                                               (14488758.015369069, 11690045.220382353), 
                                               (14488758.015369069, 10907300.076710137), 
                                               (14488758.015369069, 10898927.28957483)]}
        ff_aqua_args['reg_npv'] =  {1: 25520.257952021995, 4: 111617.57735288182}
        
        self.ff_aqua_args = ff_aqua_args
        
    def test_calc_cycle_history(self):
        self.maxDiff = None
    
        cycle_history = finfish_aquaculture_core.calc_farm_cycles(
                                self.ff_aqua_args['outplant_buffer'], self.ff_aqua_args['g_param_a'],
                                self.ff_aqua_args['g_param_b'], self.ff_aqua_args['water_temp_tbl'],
                                self.ff_aqua_args['farm_op_tbl'], self.ff_aqua_args['duration'])
        
        #LOGGER.debug(reg_cy_hist)
        #LOGGER.debug(cycle_history)
        
        self.assertEqual(self.ff_aqua_args['reg_cy_hist'], cycle_history)
    
    def test_calc_proc_weight(self):
        
        total_proc_weight, indiv_cy_proc = finfish_aquaculture_core.calc_proc_weight(
                               self.ff_aqua_args['farm_op_tbl'], self.ff_aqua_args['frac_post_process'],
                               self.ff_aqua_args['mort_rate_daily'], self.ff_aqua_args['reg_cy_hist'])
        
        
        #LOGGER.debug(total_proc_weight)
        #LOGGER.debug(indiv_cy_proc)
        
        self.maxDiff = None
        self.assertEqual(total_proc_weight, self.ff_aqua_args['tpw_totals'])
        self.assertEqual(indiv_cy_proc, self.ff_aqua_args['indiv_cy_tpw'])
        
    def test_valuation(self):
        
        if self.ff_aqua_args['do_valuation'] == True:
            
            value_history, farms_npv = finfish_aquaculture_core.valuation(self.ff_aqua_args['p_per_kg'],
                                            self.ff_aqua_args['frac_p'], self.ff_aqua_args['discount'],
                                            self.ff_aqua_args['indiv_cy_tpw'],
                                            self.ff_aqua_args['reg_cy_hist'])
            
            #LOGGER.debug(value_history)
            
            
            self.maxDiff = None
            self.assertEqual(value_history, self.ff_aqua_args['reg_value_hist'])

            #Have to re-write the check almost equal, since the assert doesn't
            #support dictionaries
            for item in farms_npv:
                
                self.assertAlmostEqual(farms_npv[item], 
                                       self.ff_aqua_args['reg_npv'][item], 2)
        else:
            pass
        
        finfish_aquaculture_core.create_HTML_table(self.ff_aqua_args['workspace_dir'] + os.sep + 'Output', 
                        self.ff_aqua_args['farm_op_tbl'], self.ff_aqua_args['reg_cy_hist'], 
                        self.ff_aqua_args['tpw_totals'], self.ff_aqua_args['indiv_cy_tpw'], 
                        self.ff_aqua_args['do_valuation'], self.ff_aqua_args['reg_npv'], 
                        self.ff_aqua_args['reg_value_hist'])
        
